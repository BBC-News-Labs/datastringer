<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>test</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
  <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
  <script src="http://maps.google.com/maps/api/js?sensor=true&.js"></script>
  <script src="https://raw.githubusercontent.com/HPNeo/gmaps/master/gmaps.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js"></script>
  <style>
  html,
  body,
  #map {
    display: block;
    width: 100%;
    height: 500px;
  }
  div {
    display: inline-block;
  }
  table td {
    border: 1px solid black;
    padding: 10px;
  }
  </style>
</head>

<body>
  <div class="container">
    <h2>Map input
      <small>- just for fun</small>
    </h2>
    <input type="text" id="latlng" size="40" />
    <br>
    <div id="map"></div>
    <div id="jan">
      <h4>Jan 2014</h4>
    </div>
    <div id="feb">
      <h4>Feb 2014</h4>
    </div>
    <div id="march">
      <h4>March 2014</h4>
    </div>
    <div id="april">
      <h4>April 2014</h4>
    </div>
    <div id="may">
      <h4>May 2014</h4>
    </div>
    <div id="results">
      <h4>Results</h4>
    </div>
  </div>
  <script>
  //I LIKE GLOBALS
  window.globalVar = {
    crimeArray: new Array()
  };
  var gVar = window.globalVar;

  //Defines map
  //Attaches event to "click"
  var map = new GMaps({
    div: '#map',
    lat: 51.5286417,
    lng: -0.1015987,
    zoom: 12,
    click: function(event) {
      var lat = event.latLng.lat();
      var lng = event.latLng.lng();
      $('#latlng').val(lat + ', ' + lng);

      crimeQueries("http://data.police.uk/api/crimes-street/all-crime?lat=" +
        lat + "&lng=" + lng + "&date=2014-01", "#jan", 0);
      crimeQueries("http://data.police.uk/api/crimes-street/all-crime?lat=" +
        lat + "&lng=" + lng + "&date=2014-02", "#feb", 1);
      crimeQueries("http://data.police.uk/api/crimes-street/all-crime?lat=" +
        lat + "&lng=" + lng + "&date=2014-03", "#march", 2);
      crimeQueries("http://data.police.uk/api/crimes-street/all-crime?lat=" +
        lat + "&lng=" + lng + "&date=2014-04", "#april", 3);
      crimeQueries("http://data.police.uk/api/crimes-street/all-crime?lat=" +
        lat + "&lng=" + lng + "&date=2014-05", "#may", 4);
    }
  });

  function crimeQueries(path_json, div_id, no) {
    $.getJSON(path_json, function(data) {
      $("#map").remove();
      var categories = new Array();
      var crimeNumbers = new Array(); //will be filled with total numbers for each crime category

      var categories = _.pluck(data, 'category'); //list all values
      var categories = _.uniq(categories); //boils down to unique values

      for (var i = 0; i < categories.length; i++) {
        var totalByCategory = _.filter(data, function(data) {
          return data.category == categories[i]
        });
        crimeNumbers.push(totalByCategory.length);
      }

      var crime = _.zip(categories, crimeNumbers); //assembles the two arrays
      //console.log(crime);
      gVar.crimeArray[no] = crime; //sends to global scope to be used for stats

      //Check if global variables have been populated
      //and thus ready for stat analysis
      if (gVar.crimeArray[0] && gVar.crimeArray[1] && gVar.crimeArray[2] &&
          gVar.crimeArray[3] && gVar.crimeArray[4]) {
        stats();
      } else {
        console.log("All JSON requests have not yet been made. Please wait.");
      }

      var tableData = crime;
      var $table = $("<table></table>");

      for (var y = 0; y < tableData.length; y++) {
        var $line = $("<tr></tr>");
        $line.append($("<td></td>").html(tableData[y][0]));
        $line.append($("<td></td>").html(tableData[y][1]));
        $table.append($line);
      }
      $table.appendTo($(div_id));
    });
  }

  function stats() {
    //Functions
    function stuff(month1, month2, month3, month4, month5, total) {
      var av = (month1 + month2 + month3 + month4 + month5) / total;
      var diff = (month5 / av * 100) - 100;
      return {
        average: av,
        monthDiff: diff
      };
    };

    var stat1 = gVar.crimeArray[0];
    var stat2 = gVar.crimeArray[1];
    var stat3 = gVar.crimeArray[2];
    var stat4 = gVar.crimeArray[3];
    var stat5 = gVar.crimeArray[4];
    var numberOfMonths = 5;

    var average1 = stuff(stat1[0][1], stat2[0][1], stat3[0][1], stat4[0][1], stat5[0][1], 5);
    console.log("The average " + stat1[0][0] + " arrests is: " + Math.round(average1.average));
    console.log("This month, " + stat1[0][0] + "  arrests changed by: " + Math.round(average1.monthDiff) + "%");
    $("#results").append("<p></p>").html("The average of" + stat1[0][0] + "  arrests per month is " + Math.round(average1.average) + "<br>" + "This month, " + stat1[0][0] + " arrests changed by " + Math.round(average1.monthDiff) + "%");

    /*@TODO in stats()
      function stuff( as many parameters as we have gVar.crimeArray ) {
        calculate average
        valculate diff
        return {
          average: av,
          monthDiff: diff
        }
      } see line 138 and following

      append to #results:
      "The average of " + stat5[i][0] + (...) + average
      Same thing for diff
      see line 157 for example
    */
  }
  </script>
</body>

</html>
