<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>test</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
  <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
  <script src="http://maps.google.com/maps/api/js?sensor=true&.js"></script>
  <script src="https://raw.githubusercontent.com/HPNeo/gmaps/master/gmaps.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js"></script>
  <style>
  html,
  body,
  #map {
    display: block;
    width: 100%;
    height: 500px;
  }
  div {
    display: inline-block;
  }
  table td {
    border: 1px solid black;
    padding: 10px;
  }
  </style>
</head>

<body>
  <div class="container">
    <h2>Map input
      <small>- just for fun</small>
    </h2>
    <input type="text" id="latlng" size="40" />
    <br>
    <div id="map"></div>
    <div id="jan">
      <h4>Jan 2014</h4>
    </div>
    <div id="feb">
      <h4>Feb 2014</h4>
    </div>
    <div id="march">
      <h4>April 2014</h4>
    </div>
    <div id="april">
      <h4>May 2014</h4>
    </div>
  </div>
  <script>
  //I LIKE GLOBALS
  window.globalVar = {
    coordinates: {
      lat: null,
      lng: null
    },
    crimeArrays: {
      1: null,
      2: null,
      3: null,
      4: null,
    }
  };
  var gVar = window.globalVar;

  //Defines map
  //Attaches event to "click"
  var map = new GMaps({
    div: '#map',
    lat: 51.5286417,
    lng: -0.1015987,
    zoom: 12,
    click: function(event) {
      gVar.coordinates.lat = event.latLng.lat();
      gVar.coordinates.lng = event.latLng.lng();
      $('#latlng').val(gVar.coordinates.lat + ', ' + gVar.coordinates.lng);

      function stats(path_json, div_id, no) {
        var data = $.getJSON(path_json, foo);

        function foo(data) {
          $("#map").remove();
          var categories = new Array();
          var crimeNumbers = new Array(); //will be filled with total numbers for each crime category

          var categories = _.pluck(data, 'category'); //list all values
          var categories = _.uniq(categories); //boils down to unique values

          for (var i = 0; i < categories.length; i++) {
            var totalByCategory = _.filter(data, function(data) {
              return data.category == categories[i]
            });
            crimeNumbers.push(totalByCategory.length);
          }

          var crime = _.zip(categories, crimeNumbers); //assembles the two arrays
          console.log(crime);
          gVar.crimeArrays[no] = crime; //sends to global scope to be used for stats

          var tableData = crime;
          var $table = $("<table></table>");

          for (var y = 0; y < tableData.length; y++) {
            var $line = $("<tr></tr>");
            $line.append($("<td></td>").html(tableData[y][0]));
            $line.append($("<td></td>").html(tableData[y][1]));
            $table.append($line);
          }
          $table.appendTo($(div_id));
        }
      }
      stats("http://data.police.uk/api/crimes-street/all-crime?lat=" + gVar.coordinates.lat + "&lng=" + gVar.coordinates.lng + "&date=2014-01", "#jan", "1");
      stats("http://data.police.uk/api/crimes-street/all-crime?lat=" + gVar.coordinates.lat + "&lng=" + gVar.coordinates.lng + "&date=2014-02", "#feb", "2");
      stats("http://data.police.uk/api/crimes-street/all-crime?lat=" + gVar.coordinates.lat + "&lng=" + gVar.coordinates.lng + "&date=2014-03", "#march", "3");
      stats("http://data.police.uk/api/crimes-street/all-crime?lat=" + gVar.coordinates.lat + "&lng=" + gVar.coordinates.lng + "&date=2014-04", "#april", "4");
    }
  });
  </script>
</body>

</html>
